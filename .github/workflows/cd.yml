name: CD Pipeline

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  # Job de debug para ver porque não está a disparar
  debug-info:
    runs-on: self-hosted
    steps:
      - name: Debug workflow trigger
        run: |
          echo "=== DEBUG INFO ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run head_branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Current ref: ${{ github.ref }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "Workflow run status: ${{ github.event.workflow_run.status }}"
          
  build-and-deploy:
    runs-on: self-hosted
    needs: debug-info
    # Simplificando a condição - só verifica se CI teve sucesso
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          clean: true
          fetch-depth: 0
      
      - name: Debug - Show workflow trigger
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch || github.ref }}"
          echo "Current commit: $(git rev-parse HEAD)"
          git log --oneline -1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Build frontend (sem testes - já executados no CI)
      - name: Instalar dependências frontend
        run: npm install --legacy-peer-deps
        working-directory: ./react-frontend/frontend
      
      - name: Build frontend
        run: npm run build
        working-directory: ./react-frontend/frontend

      # Setup backend (sem testes - já executados no CI)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn --version
        continue-on-error: false
      
      # Build backend (sem testes)
      - name: Build user_service
        run: mvn clean package -DskipTests --no-transfer-progress
        working-directory: ./slms-backend/user_service
      
      # Docker Build and Push
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Docker image (backend)
        uses: docker/build-push-action@v5
        with:
          context: ./slms-backend/user_service
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/user-service:latest
      - name: Build and push Docker image (frontend)
        uses: docker/build-push-action@v5
        with:
          context: ./react-frontend/frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/slms-frontend:latest
      # Deploy direto no runner auto-hospedado
      - name: Cleanup existing containers and networks
        if: runner.os == 'Linux' || runner.os == 'Windows'
        run: |
          echo "Stopping all running containers..."
          CONTAINERS=$(docker ps -q)
          if [ ! -z "$CONTAINERS" ]; then
            docker stop $CONTAINERS || true
          else
            echo "No containers to stop"
          fi
          echo "Removing all stopped containers..."
          docker container prune -f || true
          echo "Removing unused networks..."
          docker network prune -f || true
        shell: bash
        continue-on-error: true
      
      - name: Deploy no runner auto-hospedado
        if: runner.os == 'Linux' || runner.os == 'Windows'
        run: |
          echo "Fazendo pull das imagens Docker mais recentes..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/user-service:latest || true
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/slms-frontend:latest || true
          echo "Reiniciando containers com docker-compose..."
          cd slms-backend
          docker-compose down -v || true
          docker-compose up -d
          cd ../react-frontend/frontend
          docker-compose down -v || true
          docker-compose up -d || true
        shell: bash
      
      # Download dos resultados Allure do CI
      - name: Download Allure results (user_service)
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_run'
        with:
          name: allure-results-user_service
          path: slms-backend/user_service/allure-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Download Allure results (carrier_service)
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_run'
        with:
          name: allure-results-carrier_service
          path: slms-backend/carrier_service/carrier_service/allure-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Download Allure results (order_service)
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_run'
        with:
          name: allure-results-order_service
          path: slms-backend/order_service/demo/allure-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Download Allure results (frontend)
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_run'
        with:
          name: allure-results-frontend
          path: react-frontend/frontend/allure-results
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Deploy Allure Reports Container
        if: runner.os == 'Linux' || runner.os == 'Windows'
        run: |
          echo "Reiniciando container de relatórios Allure..."
          cd slms-backend
          docker-compose -f docker-compose.allure.yml down || true
          docker-compose -f docker-compose.allure.yml up -d --build
          echo "✅ Container Allure disponível em http://localhost:8080"
        shell: bash
        continue-on-error: true
