name: CD Pipeline - Azure Deployment

on:
  push:
    branches:
      - cd-test
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  # Espera pelo CI antes de fazer deploy yayayaya
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`Waiting for CI workflow to complete for commit ${sha}...`);
            
            const maxAttempts = 60; // 30 minutos (30 segundos * 60)
            let attempt = 0;
            
            while (attempt < maxAttempts) {
              // Get all workflow runs for this commit
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                event: 'push',
                head_sha: sha,
              });
              
              // Find the CI workflow
              const ciRun = runs.workflow_runs.find(run => run.name === 'CI');
              
              if (ciRun) {
                console.log(`CI workflow status: ${ciRun.status}, conclusion: ${ciRun.conclusion}`);
                
                if (ciRun.status === 'completed') {
                  if (ciRun.conclusion === 'success') {
                    console.log('‚úÖ CI passed! Proceeding with deployment...');
                    return;
                  } else {
                    core.setFailed(`‚ùå CI failed with conclusion: ${ciRun.conclusion}`);
                    return;
                  }
                }
              }
              
              console.log(`Attempt ${attempt + 1}/${maxAttempts}: CI still running, waiting 30 seconds...`);
              await new Promise(resolve => setTimeout(resolve, 30000));
              attempt++;
            }
            
            core.setFailed('‚ùå Timeout waiting for CI to complete');
          
  build-and-deploy-azure:
    runs-on: [self-hosted, Linux, X64, es2526-204]
    needs: wait-for-ci
    steps:

          
  build-and-deploy-azure:
    runs-on: [self-hosted, 204_runner]
    needs: wait-for-ci
    steps:
      - name: Verificar se √© o runner correto
        run: |
          echo "üîç Runner Name: $RUNNER_NAME"
          echo "üîç Runner OS: $RUNNER_OS"
          echo "üîç Verificando se tem Azure CLI, Docker e Terraform..."
          
          HAS_AZURE_CLI=$(command -v az >/dev/null 2>&1 && echo "yes" || echo "no")
          HAS_DOCKER=$(command -v docker >/dev/null 2>&1 && echo "yes" || echo "no")
          HAS_TERRAFORM=$(command -v terraform >/dev/null 2>&1 && echo "yes" || echo "no")
          
          echo "Azure CLI: $HAS_AZURE_CLI"
          echo "Docker: $HAS_DOCKER"
          echo "Terraform: $HAS_TERRAFORM"
          
          if [ "$HAS_AZURE_CLI" != "yes" ] || [ "$HAS_DOCKER" != "yes" ]; then
            echo "‚ùå Este runner n√£o tem as ferramentas necess√°rias!"
            echo "üí° O CD precisa de correr no runner 204_runner (Azure VM)"
            echo "Por favor, garante que o runner 204_runner est√° online e com a label correta"
            exit 1
          fi
          
          echo "‚úÖ Runner v√°lido para deployment Azure!"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0
      
      - name: Debug - Show deployment info
        run: |
          echo "üöÄ Iniciando deployment para Azure"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: $(git rev-parse HEAD)"
          git log --oneline -1

      # ==========================================
      # AZURE AUTHENTICATION
      # ==========================================
      - name: Login no Azure com Managed Identity
        run: |
          echo "üîê Autenticando no Azure com Managed Identity..."
          az login --identity
          az account show

      - name: Login no Azure Container Registry
        run: |
          echo "üîê Autenticando no ACR..."
          az acr login --name ${{ secrets.ACR_NAME }} --identity

      # ==========================================
      # BUILD & PUSH DOCKER IMAGES
      # ==========================================
      - name: Build e Push - Backend (user_service)
        run: |
          echo "üèóÔ∏è Building Backend (user_service)..."
          cd slms-backend/user_service
          
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-backend:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-backend:latest .
          
          echo "üì§ Pushing Backend to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-backend:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-backend:latest
      
      - name: Build e Push - Carrier Service
        run: |
          echo "üèóÔ∏è Building Carrier Service..."
          cd slms-backend/carrier_service/carrier_service
          
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-carrier-service:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-carrier-service:latest .
          
          echo "üì§ Pushing Carrier Service to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-carrier-service:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-carrier-service:latest
      
      - name: Build e Push - Order Service
        run: |
          echo "üèóÔ∏è Building Order Service..."
          cd slms-backend/order_service/demo
          
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-order-service:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-order-service:latest .
          
          echo "üì§ Pushing Order Service to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-order-service:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-order-service:latest

      - name: Build e Push - Frontend
        run: |
          echo "üèóÔ∏è Building Frontend..."
          cd react-frontend/frontend
          
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-frontend:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-frontend:latest .
          
          echo "üì§ Pushing Frontend to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-frontend:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-frontend:latest

      # ==========================================
      # TERRAFORM DEPLOYMENT
      # ==========================================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Plan
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
          TF_VAR_runner_admin_password: ${{ secrets.TF_VAR_RUNNER_ADMIN_PASSWORD }}
        run: |
          cd terraform
          terraform plan

      - name: Terraform Apply
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
          TF_VAR_runner_admin_password: ${{ secrets.TF_VAR_RUNNER_ADMIN_PASSWORD }}
        run: |
          cd terraform
          terraform apply -auto-approve

      - name: Obter URLs dos servi√ßos
        run: |
          cd terraform
          FRONTEND_URL=$(terraform output -raw frontend_url_https)
          KEYCLOAK_URL=$(terraform output -raw keycloak_url)
          echo "‚úÖ Deployment completo!"
          echo "üåê Frontend URL: $FRONTEND_URL"
          echo "üîë Keycloak URL: $KEYCLOAK_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV
          echo "KEYCLOAK_URL=$KEYCLOAK_URL" >> $GITHUB_ENV

      # ==========================================
      # ALLURE REPORTS (DOWNLOAD FROM CI)
      # ==========================================
      - name: Download Allure results (user_service)
        uses: actions/download-artifact@v4
        with:
          name: allure-results-user_service
          path: slms-backend/user_service/allure-results
        continue-on-error: true
      
      - name: Download Allure results (carrier_service)
        uses: actions/download-artifact@v4
        with:
          name: allure-results-carrier_service
          path: slms-backend/carrier_service/carrier_service/allure-results
        continue-on-error: true
      
      - name: Download Allure results (order_service)
        uses: actions/download-artifact@v4
        with:
          name: allure-results-order_service
          path: slms-backend/order_service/demo/allure-results
        continue-on-error: true
      
      - name: Download Allure results (frontend)
        uses: actions/download-artifact@v4
        with:
          name: allure-results-frontend
          path: react-frontend/frontend/allure-results
        continue-on-error: true
      
      - name: Deploy Allure Reports Container
        run: |
          echo "üìä Iniciando container de relat√≥rios Allure..."
          cd slms-backend
          docker-compose -f docker-compose.allure.yml down || true
          docker-compose -f docker-compose.allure.yml up -d --build
          echo "‚úÖ Container Allure dispon√≠vel localmente no runner"
        continue-on-error: true

      # ==========================================
      # DEPLOYMENT SUMMARY
      # ==========================================
      - name: Criar coment√°rio com resultado
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const frontendUrl = process.env.FRONTEND_URL || 'N/A';
            const keycloakUrl = process.env.KEYCLOAK_URL || 'N/A';
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `## ${emoji} Azure Deployment ${status}
            
            **Frontend URL:** ${frontendUrl}
            **Keycloak URL:** ${keycloakUrl}
            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.ref_name }}\`
            **Triggered by:** @${{ github.actor }}
            
            ### Services Deployed:
            - üåê Frontend (Nginx)
            - üîß Backend (user_service)
            - üì¶ Carrier Service
            - üìã Order Service
            - üîë Keycloak (Auth)
            - üóÑÔ∏è PostgreSQL Database
            `;
            
            console.log(comment);
