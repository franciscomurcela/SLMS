name: Deploy to Azure

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Login no Azure com Managed Identity
        run: |
          echo "üîê Autenticando no Azure com Managed Identity..."
          az login --identity
          az account show

      - name: Login no Azure Container Registry
        run: |
          echo "üîê Autenticando no ACR..."
          az acr login --name ${{ secrets.ACR_NAME }} --identity

      - name: Build e Push - Backend Image
        run: |
          echo "üèóÔ∏è Building Backend..."
          cd slms-backend/user_service
          
          # Obter o login server do ACR
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-backend:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-backend:latest .
          
          echo "üì§ Pushing Backend to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-backend:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-backend:latest

      - name: Build e Push - Frontend Image
        run: |
          echo "üèóÔ∏è Building Frontend..."
          cd react-frontend/frontend
          
          # Obter o login server do ACR
          ACR_LOGIN_SERVER=$(az acr show --name ${{ secrets.ACR_NAME }} --query loginServer -o tsv)
          
          docker build -t ${ACR_LOGIN_SERVER}/slms-frontend:${{ github.sha }} .
          docker build -t ${ACR_LOGIN_SERVER}/slms-frontend:latest .
          
          echo "üì§ Pushing Frontend to ACR..."
          docker push ${ACR_LOGIN_SERVER}/slms-frontend:${{ github.sha }}
          docker push ${ACR_LOGIN_SERVER}/slms-frontend:latest

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Plan
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
          TF_VAR_runner_admin_password: ${{ secrets.TF_VAR_RUNNER_ADMIN_PASSWORD }}
        run: |
          cd terraform
          terraform plan

      - name: Terraform Apply
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_DB_PASSWORD }}
          TF_VAR_runner_admin_password: ${{ secrets.TF_VAR_RUNNER_ADMIN_PASSWORD }}
        run: |
          cd terraform
          terraform apply -auto-approve

      - name: Obter URL do Frontend
        run: |
          cd terraform
          FRONTEND_URL=$(terraform output -raw frontend_url_https)
          echo "‚úÖ Deployment completo!"
          echo "üåê Frontend URL: $FRONTEND_URL"
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV

      - name: Criar coment√°rio com resultado
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const frontendUrl = process.env.FRONTEND_URL || 'N/A';
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `## ${emoji} Deployment ${status}
            
            **Frontend URL:** ${frontendUrl}
            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.ref_name }}\`
            **Triggered by:** @${{ github.actor }}
            `;
            
            console.log(comment);
